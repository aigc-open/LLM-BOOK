<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1000">
  <defs>
    <!-- 定义渐变色 -->
    <linearGradient id="fxGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4A90E2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#357ABD;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="irGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#50C878;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#3A9B5C;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="processGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F39C12;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D68910;stop-opacity:1" />
    </linearGradient>

    <!-- 箭头标记 -->
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    
    <marker id="arrowheadBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#4A90E2" />
    </marker>

    <!-- 发光效果 -->
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- 背景 -->
  <rect width="1400" height="1000" fill="#f8f9fa"/>
  
  <!-- 标题 -->
  <text x="700" y="40" font-size="28" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    GraphLowering: FX Graph → Inductor IR 转换流程
  </text>

  <!-- ========== 第一部分：FX Graph (左侧) ========== -->
  <g id="fx-graph">
    <rect x="50" y="80" width="350" height="500" rx="10" fill="url(#fxGradient)" opacity="0.1" stroke="#4A90E2" stroke-width="2"/>
    <text x="225" y="110" font-size="20" font-weight="bold" text-anchor="middle" fill="#4A90E2">FX Graph</text>
    
    <!-- FX 节点 -->
    <!-- placeholder -->
    <g id="fx-placeholder" opacity="0">
      <rect x="100" y="140" width="250" height="60" rx="8" fill="#4A90E2" stroke="#357ABD" stroke-width="2"/>
      <text x="225" y="165" font-size="14" font-weight="bold" text-anchor="middle" fill="white">placeholder</text>
      <text x="225" y="185" font-size="12" text-anchor="middle" fill="white">%x : tensor[2, 128]</text>
      <animate attributeName="opacity" from="0" to="1" begin="0.5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- call_function (mul) -->
    <g id="fx-mul" opacity="0">
      <rect x="100" y="220" width="250" height="60" rx="8" fill="#4A90E2" stroke="#357ABD" stroke-width="2"/>
      <text x="225" y="245" font-size="14" font-weight="bold" text-anchor="middle" fill="white">call_function</text>
      <text x="225" y="265" font-size="12" text-anchor="middle" fill="white">%mul = aten.mul(%x, 2)</text>
      <animate attributeName="opacity" from="0" to="1" begin="2s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- call_function (add) -->
    <g id="fx-add" opacity="0">
      <rect x="100" y="300" width="250" height="60" rx="8" fill="#4A90E2" stroke="#357ABD" stroke-width="2"/>
      <text x="225" y="325" font-size="14" font-weight="bold" text-anchor="middle" fill="white">call_function</text>
      <text x="225" y="345" font-size="12" text-anchor="middle" fill="white">%add = aten.add(%mul, 1)</text>
      <animate attributeName="opacity" from="0" to="1" begin="4s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- call_function (sigmoid) -->
    <g id="fx-sigmoid" opacity="0">
      <rect x="100" y="380" width="250" height="60" rx="8" fill="#4A90E2" stroke="#357ABD" stroke-width="2"/>
      <text x="225" y="405" font-size="14" font-weight="bold" text-anchor="middle" fill="white">call_function</text>
      <text x="225" y="425" font-size="12" text-anchor="middle" fill="white">%sig = aten.sigmoid(%add)</text>
      <animate attributeName="opacity" from="0" to="1" begin="6s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- output -->
    <g id="fx-output" opacity="0">
      <rect x="100" y="460" width="250" height="60" rx="8" fill="#4A90E2" stroke="#357ABD" stroke-width="2"/>
      <text x="225" y="485" font-size="14" font-weight="bold" text-anchor="middle" fill="white">output</text>
      <text x="225" y="505" font-size="12" text-anchor="middle" fill="white">return %sig</text>
      <animate attributeName="opacity" from="0" to="1" begin="8s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- FX 节点之间的箭头 -->
    <path d="M 225 200 L 225 220" stroke="#357ABD" stroke-width="2" marker-end="url(#arrowheadBlue)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="1.5s" dur="0.3s" fill="freeze"/>
    </path>
    <path d="M 225 280 L 225 300" stroke="#357ABD" stroke-width="2" marker-end="url(#arrowheadBlue)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="3.5s" dur="0.3s" fill="freeze"/>
    </path>
    <path d="M 225 360 L 225 380" stroke="#357ABD" stroke-width="2" marker-end="url(#arrowheadBlue)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="5.5s" dur="0.3s" fill="freeze"/>
    </path>
    <path d="M 225 440 L 225 460" stroke="#357ABD" stroke-width="2" marker-end="url(#arrowheadBlue)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="7.5s" dur="0.3s" fill="freeze"/>
    </path>
  </g>

  <!-- ========== 第二部分：GraphLowering 处理器 (中间) ========== -->
  <g id="lowering-processor">
    <rect x="500" y="200" width="400" height="400" rx="10" fill="url(#processGradient)" opacity="0.1" stroke="#F39C12" stroke-width="3"/>
    <text x="700" y="230" font-size="18" font-weight="bold" text-anchor="middle" fill="#D68910">GraphLowering 处理器</text>
    
    <!-- 核心组件 -->
    <g id="env-map" opacity="0">
      <rect x="530" y="250" width="340" height="80" rx="8" fill="white" stroke="#F39C12" stroke-width="2"/>
      <text x="700" y="275" font-size="14" font-weight="bold" text-anchor="middle" fill="#D68910">env: Dict[FX Node → IR Node]</text>
      <text x="700" y="295" font-size="11" text-anchor="middle" fill="#666">存储转换结果</text>
      <text x="700" y="315" font-size="10" text-anchor="middle" fill="#999" font-family="monospace">
        {%x: TensorBox(InputBuffer), ...}
      </text>
      <animate attributeName="opacity" from="0" to="1" begin="1s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- lowerings 字典 -->
    <g id="lowerings-dict" opacity="0">
      <rect x="530" y="350" width="340" height="80" rx="8" fill="white" stroke="#F39C12" stroke-width="2"/>
      <text x="700" y="375" font-size="14" font-weight="bold" text-anchor="middle" fill="#D68910">lowerings 注册表</text>
      <text x="700" y="395" font-size="11" text-anchor="middle" fill="#666">ATen 算子 → Lowering 函数</text>
      <text x="700" y="415" font-size="10" text-anchor="middle" fill="#999" font-family="monospace">
        {aten.add: add_tensor, aten.mul: mul_tensor}
      </text>
      <animate attributeName="opacity" from="0" to="1" begin="1.5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- 处理流程指示器 -->
    <g id="process-indicator">
      <circle cx="700" cy="480" r="40" fill="#F39C12" opacity="0">
        <animate attributeName="opacity" values="0;0.8;0" begin="2s" dur="2s" repeatCount="3"/>
      </circle>
      <text x="700" y="488" font-size="12" font-weight="bold" text-anchor="middle" fill="white">
        处理中
        <animate attributeName="opacity" values="0;1;0" begin="2s" dur="2s" repeatCount="3"/>
      </text>
    </g>
    
    <!-- 处理步骤说明 -->
    <g id="step-explanation" opacity="0">
      <text x="700" y="540" font-size="11" text-anchor="middle" fill="#666">
        <tspan x="700" dy="0">① 遍历 FX 节点</tspan>
        <tspan x="700" dy="18">② 查找对应 lowering 函数</tspan>
        <tspan x="700" dy="18">③ 生成 IR 节点</tspan>
        <tspan x="700" dy="18">④ 存入 env 映射</tspan>
      </text>
      <animate attributeName="opacity" from="0" to="1" begin="2s" dur="0.5s" fill="freeze"/>
    </g>
  </g>

  <!-- ========== 第三部分：Inductor IR (右侧) ========== -->
  <g id="inductor-ir">
    <rect x="1000" y="80" width="350" height="500" rx="10" fill="url(#irGradient)" opacity="0.1" stroke="#50C878" stroke-width="2"/>
    <text x="1175" y="110" font-size="20" font-weight="bold" text-anchor="middle" fill="#50C878">Inductor IR</text>
    
    <!-- IR 节点 -->
    <!-- InputBuffer -->
    <g id="ir-input" opacity="0">
      <rect x="1050" y="140" width="250" height="70" rx="8" fill="#50C878" stroke="#3A9B5C" stroke-width="2"/>
      <text x="1175" y="165" font-size="14" font-weight="bold" text-anchor="middle" fill="white">InputBuffer</text>
      <text x="1175" y="185" font-size="11" text-anchor="middle" fill="white">name='x'</text>
      <text x="1175" y="200" font-size="11" text-anchor="middle" fill="white">shape=[2, 128]</text>
      <animate attributeName="opacity" from="0" to="1" begin="1.5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- Pointwise (mul) -->
    <g id="ir-mul" opacity="0">
      <rect x="1050" y="230" width="250" height="70" rx="8" fill="#50C878" stroke="#3A9B5C" stroke-width="2"/>
      <text x="1175" y="255" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Pointwise</text>
      <text x="1175" y="275" font-size="10" text-anchor="middle" fill="white">inner_fn: ops.mul(load(x), 2)</text>
      <text x="1175" y="290" font-size="10" text-anchor="middle" fill="white">ranges=[2, 128]</text>
      <animate attributeName="opacity" from="0" to="1" begin="3s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- Pointwise (add) -->
    <g id="ir-add" opacity="0">
      <rect x="1050" y="320" width="250" height="70" rx="8" fill="#50C878" stroke="#3A9B5C" stroke-width="2"/>
      <text x="1175" y="345" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Pointwise</text>
      <text x="1175" y="365" font-size="10" text-anchor="middle" fill="white">inner_fn: ops.add(load(buf), 1)</text>
      <text x="1175" y="380" font-size="10" text-anchor="middle" fill="white">ranges=[2, 128]</text>
      <animate attributeName="opacity" from="0" to="1" begin="5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- Pointwise (sigmoid) -->
    <g id="ir-sigmoid" opacity="0">
      <rect x="1050" y="410" width="250" height="70" rx="8" fill="#50C878" stroke="#3A9B5C" stroke-width="2"/>
      <text x="1175" y="435" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Pointwise</text>
      <text x="1175" y="455" font-size="10" text-anchor="middle" fill="white">inner_fn: ops.sigmoid(load(buf))</text>
      <text x="1175" y="470" font-size="10" text-anchor="middle" fill="white">ranges=[2, 128]</text>
      <animate attributeName="opacity" from="0" to="1" begin="7s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- TensorBox 说明 -->
    <g id="tensorbox-note" opacity="0">
      <rect x="1050" y="500" width="250" height="60" rx="8" fill="#E8F5E9" stroke="#50C878" stroke-width="1" stroke-dasharray="5,5"/>
      <text x="1175" y="525" font-size="12" font-weight="bold" text-anchor="middle" fill="#3A9B5C">TensorBox 包装</text>
      <text x="1175" y="545" font-size="10" text-anchor="middle" fill="#666">统一接口，延迟计算</text>
      <animate attributeName="opacity" from="0" to="1" begin="8s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- IR 节点之间的箭头 -->
    <path d="M 1175 210 L 1175 230" stroke="#3A9B5C" stroke-width="2" marker-end="url(#arrowhead)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="2.5s" dur="0.3s" fill="freeze"/>
    </path>
    <path d="M 1175 300 L 1175 320" stroke="#3A9B5C" stroke-width="2" marker-end="url(#arrowhead)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="4.5s" dur="0.3s" fill="freeze"/>
    </path>
    <path d="M 1175 390 L 1175 410" stroke="#3A9B5C" stroke-width="2" marker-end="url(#arrowhead)" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="6.5s" dur="0.3s" fill="freeze"/>
    </path>
  </g>

  <!-- ========== 数据流动箭头 (FX → Lowering) ========== -->
  <g id="flow-fx-to-lowering">
    <!-- placeholder 转换 -->
    <path d="M 350 170 Q 425 170 500 250" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowheadBlue)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="1s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="1s" dur="0.3s" fill="freeze"/>
    </path>
    
    <!-- mul 转换 -->
    <path d="M 350 250 Q 425 250 500 350" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowheadBlue)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="3s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="3s" dur="0.3s" fill="freeze"/>
    </path>
    
    <!-- add 转换 -->
    <path d="M 350 330 Q 425 330 500 380" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowheadBlue)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="5s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="5s" dur="0.3s" fill="freeze"/>
    </path>
    
    <!-- sigmoid 转换 -->
    <path d="M 350 410 Q 425 410 500 450" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowheadBlue)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="7s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="7s" dur="0.3s" fill="freeze"/>
    </path>
  </g>

  <!-- ========== 数据流动箭头 (Lowering → IR) ========== -->
  <g id="flow-lowering-to-ir">
    <!-- InputBuffer 生成 -->
    <path d="M 900 280 Q 950 210 1000 175" stroke="#50C878" stroke-width="3" fill="none" marker-end="url(#arrowhead)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="2s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="2s" dur="0.3s" fill="freeze"/>
    </path>
    
    <!-- Pointwise (mul) 生成 -->
    <path d="M 900 380 Q 950 310 1000 265" stroke="#50C878" stroke-width="3" fill="none" marker-end="url(#arrowhead)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="4s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="4s" dur="0.3s" fill="freeze"/>
    </path>
    
    <!-- Pointwise (add) 生成 -->
    <path d="M 900 400 Q 950 365 1000 355" stroke="#50C878" stroke-width="3" fill="none" marker-end="url(#arrowhead)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="6s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="6s" dur="0.3s" fill="freeze"/>
    </path>
    
    <!-- Pointwise (sigmoid) 生成 -->
    <path d="M 900 480 Q 950 445 1000 445" stroke="#50C878" stroke-width="3" fill="none" marker-end="url(#arrowhead)" opacity="0" stroke-dasharray="1000" stroke-dashoffset="1000">
      <animate attributeName="stroke-dashoffset" from="1000" to="0" begin="8s" dur="0.8s" fill="freeze"/>
      <animate attributeName="opacity" from="0" to="0.6" begin="8s" dur="0.3s" fill="freeze"/>
    </path>
  </g>

  <!-- ========== 底部说明 ========== -->
  <g id="bottom-notes">
    <rect x="50" y="620" width="1300" height="340" rx="10" fill="white" stroke="#ddd" stroke-width="2" opacity="0">
      <animate attributeName="opacity" from="0" to="1" begin="9s" dur="0.5s" fill="freeze"/>
    </rect>
    
    <!-- 关键概念 -->
    <text x="700" y="655" font-size="18" font-weight="bold" text-anchor="middle" fill="#2c3e50" opacity="0">
      关键概念
      <animate attributeName="opacity" from="0" to="1" begin="9.5s" dur="0.5s" fill="freeze"/>
    </text>
    
    <g id="concept-1" opacity="0">
      <circle cx="100" cy="700" r="8" fill="#4A90E2"/>
      <text x="120" y="705" font-size="13" font-weight="bold" fill="#333">1. FX Graph</text>
      <text x="120" y="725" font-size="11" fill="#666">符号化表示的计算图，通过 torch.fx.symbolic_trace 生成</text>
      <animate attributeName="opacity" from="0" to="1" begin="10s" dur="0.5s" fill="freeze"/>
    </g>
    
    <g id="concept-2" opacity="0">
      <circle cx="100" cy="760" r="8" fill="#F39C12"/>
      <text x="120" y="765" font-size="13" font-weight="bold" fill="#333">2. GraphLowering</text>
      <text x="120" y="785" font-size="11" fill="#666">继承 torch.fx.Interpreter，遍历 FX 节点并调用 lowering 函数</text>
      <animate attributeName="opacity" from="0" to="1" begin="10.5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <g id="concept-3" opacity="0">
      <circle cx="100" cy="820" r="8" fill="#50C878"/>
      <text x="120" y="825" font-size="13" font-weight="bold" fill="#333">3. Inductor IR</text>
      <text x="120" y="845" font-size="11" fill="#666">低层中间表示，包含 InputBuffer, Pointwise, Reduction 等节点</text>
      <animate attributeName="opacity" from="0" to="1" begin="11s" dur="0.5s" fill="freeze"/>
    </g>
    
    <g id="concept-4" opacity="0">
      <circle cx="750" cy="700" r="8" fill="#E74C3C"/>
      <text x="770" y="705" font-size="13" font-weight="bold" fill="#333">4. lowerings 注册表</text>
      <text x="770" y="725" font-size="11" fill="#666">字典映射：ATen 算子 → Lowering 函数，通过装饰器注册</text>
      <animate attributeName="opacity" from="0" to="1" begin="11.5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <g id="concept-5" opacity="0">
      <circle cx="750" cy="760" r="8" fill="#9B59B6"/>
      <text x="770" y="765" font-size="13" font-weight="bold" fill="#333">5. TensorBox</text>
      <text x="770" y="785" font-size="11" fill="#666">包装器，提供统一接口，支持延迟计算和实体化</text>
      <animate attributeName="opacity" from="0" to="1" begin="12s" dur="0.5s" fill="freeze"/>
    </g>
    
    <g id="concept-6" opacity="0">
      <circle cx="750" cy="820" r="8" fill="#16A085"/>
      <text x="770" y="825" font-size="13" font-weight="bold" fill="#333">6. inner_fn (延迟计算)</text>
      <text x="770" y="845" font-size="11" fill="#666">构建表达式树而非立即执行，为后续融合和代码生成做准备</text>
      <animate attributeName="opacity" from="0" to="1" begin="12.5s" dur="0.5s" fill="freeze"/>
    </g>
    
    <!-- 代码示例 -->
    <g id="code-example" opacity="0">
      <rect x="100" y="880" width="550" height="60" rx="5" fill="#f5f5f5" stroke="#ccc" stroke-width="1"/>
      <text x="375" y="900" font-size="11" font-family="monospace" text-anchor="middle" fill="#333">
        <tspan x="120" dy="0" text-anchor="start">@register_lowering(torch.ops.aten.add)</tspan>
        <tspan x="120" dy="15" text-anchor="start">def add_tensor(x, y):</tspan>
        <tspan x="140" dy="15" text-anchor="start">return Pointwise.create(..., inner_fn=...)</tspan>
      </text>
      <animate attributeName="opacity" from="0" to="1" begin="13s" dur="0.5s" fill="freeze"/>
    </g>
    
    <g id="flow-example" opacity="0">
      <rect x="700" y="880" width="600" height="60" rx="5" fill="#f5f5f5" stroke="#ccc" stroke-width="1"/>
      <text x="1000" y="900" font-size="11" font-family="monospace" text-anchor="middle" fill="#333">
        <tspan x="720" dy="0" text-anchor="start">FX: %add = aten.add(%x, %y)</tspan>
        <tspan x="720" dy="15" text-anchor="start">↓ GraphLowering.call_function()</tspan>
        <tspan x="720" dy="15" text-anchor="start">IR: TensorBox(Pointwise(inner_fn=ops.add(load(x), load(y))))</tspan>
      </text>
      <animate attributeName="opacity" from="0" to="1" begin="13s" dur="0.5s" fill="freeze"/>
    </g>
  </g>

  <!-- 循环动画指示器 -->
  <g id="replay-hint" opacity="0">
    <text x="700" y="980" font-size="12" text-anchor="middle" fill="#999">
      动画将循环播放...
    </text>
    <animate attributeName="opacity" values="0;1;0" begin="14s" dur="2s" repeatCount="indefinite"/>
  </g>

  <!-- 循环整个动画 -->
  <animate attributeName="opacity" from="1" to="1" begin="16s" dur="0.1s" onend="document.documentElement.setCurrentTime(0)"/>
</svg>

